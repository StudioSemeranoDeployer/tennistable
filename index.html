<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tennis Cerca & Gioca</title>
  <style>
    /* --- CSS STYLES (Invariati) --- */
    :root { --primary: #2c3e50; --accent: #e67e22; --bg: #f4f4f9; --card-bg: #fff; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, sans-serif; background: var(--bg); color: var(--primary); display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; }
    header { background: var(--primary); color: white; width: 100%; padding: 1rem; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    #app { width: 100%; max-width: 600px; padding: 20px; }
    button { cursor: pointer; border: none; padding: 10px 20px; border-radius: 6px; font-size: 1rem; transition: background 0.2s; }
    .btn-primary { background: var(--accent); color: white; width: 100%; margin-bottom: 10px;}
    .btn-primary:hover { background: #d35400; }
    .btn-secondary { background: #95a5a6; color: white; }
    .btn-small { padding: 5px 10px; font-size: 0.9rem; }
    .card { background: var(--card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid var(--accent); }
    .card h3 { margin-top: 0; }
    .status-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; background: #e0e0e0; }
    .status-full { background: #f8d7da; color: #721c24; }
    .status-open { background: #d4edda; color: #155724; }
    .menu-grid { display: grid; gap: 15px; margin-top: 20px; }
  </style>
</head>
<body>

<header>
  <h1>üéæ Tennis Match</h1>
</header>

<main id="app">
  <p style="text-align:center">Caricamento applicazione...</p>
</main>

<script>
  /* --- CONFIGURAZIONE CLOUD (Tua ID inserita) --- */
  const BIN_ID = "69272ed843b1c97be9c6cd79"; 
  
  // ‚ö†Ô∏è INCOLLA QUI LA TUA CHIAVE (inizia con $2a$10...)
  const API_KEY = "$2a$10$aMh1mO8btCVSqfcvlxvUJeJ6p.7kHJlSyKz7UjvTu2wqRAQlAcAXe"; 
  
  const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

  /* --- DATA LAYER --- */
  const courts = [
    { id: 1, name: "Club Centrale", surface: "Terra Rossa" },
    { id: 2, name: "Green Set Arena", surface: "Sintetico" },
    { id: 3, name: "Padel & Tennis", surface: "Erba" }
  ];

  let matches = []; 

  // 1. SCARICA DATI (Gestisce formato oggetto { matches: [] })
  async function loadMatches() {
    try {
      const res = await fetch(API_URL, {
        headers: { "X-Master-Key": API_KEY }
      });
      
      if (!res.ok) throw new Error(`Errore API: ${res.status}`);
      
      const data = await res.json();
      console.log("Dati grezzi scaricati:", data);

      // Logica robusta: cerca 'matches' dentro record, oppure usa record se √® gi√† array
      if (data.record && Array.isArray(data.record.matches)) {
        matches = data.record.matches;
      } else if (Array.isArray(data.record)) {
        matches = data.record;
      } else {
        matches = []; // Fallback vuoto
      }
      
      renderMatches(); 
    } catch (err) {
      console.error(err);
      alert("Errore di connessione o Chiave API mancante!");
      // Se fallisce, portiamo alla home comunque
      renderHome();
    }
  }

  // 2. SALVA DATI (Salva sempre nel formato { matches: [...] })
  async function saveMatches() {
    try {
      const payload = { matches: matches }; // Avvolgiamo l'array
      
      await fetch(API_URL, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "X-Master-Key": API_KEY
        },
        body: JSON.stringify(payload)
      });
      console.log("Salvataggio completato.");
    } catch (err) {
      console.error("Errore salvataggio:", err);
      alert("Impossibile salvare i dati.");
    }
  }

  /* --- LOGIC LAYER --- */
  const app = document.getElementById('app');

  function navigate(viewName) {
    if (viewName === 'matches') {
        app.innerHTML = '<p style="text-align:center">Caricamento partite in corso...</p>';
        loadMatches(); 
    } else if (viewName === 'home') {
        renderHome();
    } else if (viewName === 'create') {
        renderCreate();
    }
  }

  async function joinMatch(matchId) {
    const match = matches.find(m => m.id === matchId);
    if (match && match.players.length < match.max) {
      const name = prompt("Inserisci il tuo nome:");
      if (name) {
        match.players.push(name);
        alert(`Ti sei unito! Salvataggio...`);
        renderMatches(); // Aggiorna subito visivamente
        await saveMatches(); // Salva sul cloud
      }
    } else {
      alert("Partita piena o non trovata!");
    }
  }

  async function createMatch(courtId, time) {
    const newMatch = {
      id: Date.now(),
      courtId: parseInt(courtId),
      date: new Date().toLocaleDateString(),
      time: time,
      players: ["Host"],
      max: 4
    };
    
    matches.push(newMatch);
    alert("Partita creata! Salvataggio...");
    await saveMatches();
    navigate('matches');
  }

  /* --- VIEW LAYER --- */
  function renderHome() {
    app.innerHTML = `
      <div style="text-align:center;">
        <h2>Benvenuto, Tifoso!</h2>
        <p>Gioca online con gli amici.</p>
      </div>
      <div class="menu-grid">
        <button class="btn-primary" onclick="navigate('matches')">üë• Cerca Partite (Online)</button>
        <button class="btn-primary" onclick="navigate('create')">üìÖ Crea Nuova Sfida</button>
      </div>
    `;
  }

  function renderMatches() {
    if(matches.length === 0) {
       app.innerHTML = `
        <button class="btn-secondary btn-small" onclick="navigate('home')">‚¨Ö Indietro</button>
        <h2>Partite Online</h2>
        <div class="card"><p>Nessuna partita trovata. Creane una tu!</p></div>`;
       return;
    }

    let cardsHtml = matches.map(m => {
      const court = courts.find(c => c.id === m.courtId) || {name: "Campo Generico", surface: "?"};
      const isFull = m.players.length >= m.max;
      const statusClass = isFull ? 'status-full' : 'status-open';
      
      return `
        <div class="card">
          <div style="display:flex; justify-content:space-between;">
            <h3>${m.time} @ ${court.name}</h3>
            <span class="status-badge ${statusClass}">${isFull ? 'PIENO' : 'LIBERO'}</span>
          </div>
          <p>Squadra (${m.players.length}/4): ${m.players.join(", ")}</p>
          ${!isFull ? `<button class="btn-primary btn-small" onclick="joinMatch(${m.id})">Unisciti</button>` : ''}
        </div>
      `;
    }).join('');

    app.innerHTML = `
      <button class="btn-secondary btn-small" onclick="navigate('home')">‚¨Ö Indietro</button>
      <h2>Partite Online</h2>
      ${cardsHtml}
    `;
  }

  function renderCreate() {
    const options = courts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    app.innerHTML = `
      <button class="btn-secondary btn-small" onclick="navigate('home')">‚¨Ö Indietro</button>
      <h2>Crea Partita</h2>
      <div class="card">
        <label>Campo:</label>
        <select id="courtSelect" style="width:100%; margin:10px 0;">${options}</select>
        <label>Ora:</label>
        <input type="time" id="timeInput" value="18:00" style="width:100%; margin:10px 0;">
        <button class="btn-primary" onclick="handleCreateClick()">Pubblica Online</button>
      </div>
    `;
  }

  window.handleCreateClick = function() {
    const courtId = document.getElementById('courtSelect').value;
    const time = document.getElementById('timeInput').value;
    createMatch(courtId, time);
  }

  // Avvio
  navigate('home');
</script>
</body>
</html>
